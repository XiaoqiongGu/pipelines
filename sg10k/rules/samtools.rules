"""Some samtools rules taken from snakemake-workflows.git/bio/ngs/rules/mapping/samfiles.rules

Requires samtools

Original author: Johannes KÃ¶ster (http://johanneskoester.bitbucket.org)
Original license: MIT
"""

rule samtools_fasta_index:
    input:
        "{prefix}.{suffix}"
    output:
        "{prefix}.{suffix,(fasta|fa)}.fai"
    shell:
        "use samtools-{config[modules][samtools]};"
        "samtools faidx {input};"
    
rule map_rate:
    input:
        bam="{prefix}.idxstats.txt",
    output:
        "{prefix}.maprate.txt"
    shell:
        "cat {input} | awk '{{a+=$3; u+=$4}} END {{printf \"%.2f\\n\", a/(a+u)}}' > {output}"

rule bam_idxstats:
    input:
        bam="{prefix}.bam",
        bai="{prefix}.bam.bai"
    output:
        "{prefix}.idxstats.txt"
    shell:
        "use samtools-{config[modules][samtools]};"
        "samtools idxstats {input.bam} > {output};"


rule bam_index:
    input:
        "{prefix}.bam"
    output:
        "{prefix}.bam.bai"
    shell:
        "use samtools-{config[modules][samtools]};"
        "samtools index {input};"


